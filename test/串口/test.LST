C51 COMPILER V7.10   TEST                                                                  03/22/2013 20:18:22 PAGE 1   


C51 COMPILER V7.10, COMPILATION OF MODULE TEST
OBJECT MODULE PLACED IN test.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE test.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /********************************************************************
   2          * 文件名  ： 串口接收试验.c
   3          * 描述    :  该文件实现通过单片机从电脑接收数据。通过数码管显示
   4                                   该试验使用的晶振是11.0592,如果使用12M晶振，会出现串口接收
   5                                   不正常的情况。原因是用12M晶振，波特率9600时的误差率达 8%
   6                                   当下载这个程序到单片机时，单片机的最高为为乱码，是正常现象，
   7                                   按一下复位键便可。是由于单片机下载也是通过串口下载引起的。
   8          
   9          ***********************************************************************/
  10          #include<reg52.h>
  11          #include<intrins.h>
  12          sbit Led1 = P3^6;
  13          sbit Led2 = P3^7;
  14          sbit Led3 = P3^5;
  15          sbit Led4 = P3^4;
  16          #define uchar unsigned char
  17          #define uint  unsigned int 
  18          sbit BELL = P1^2;                       //设置P1.2口，为控制蜂鸣器发声的引脚
  19          #define M 4
  20          
  21          uchar code table[10] = {0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90};
  22          uchar LED_Buffer[4] = {0};      //从串口接收的数据
  23          
  24          /********************************************************************
  25          * 名称 : Delay()
  26          * 功能 : 延时子程序，延时时间为 0.1ms * x
  27          * 输入 : x (延时一毫秒的个数)
  28          * 输出 : 无
  29          ***********************************************************************/
  30          void Delay(uint i)//0.1ms延时
  31          {
  32   1              uchar x,j;
  33   1              for(j=0;j<i;j++)
  34   1                      for(x=0;x<=1;x++);      
  35   1      }
  36          /********************************************************************
  37          * 名称 : Delay_1ms()
  38          * 功能 : 延时子程序，延时时间为 1ms * x
  39          * 输入 : x (延时一毫秒的个数)
  40          * 输出 : 无
  41          ***********************************************************************/
  42          void Delay_1ms(uint i)//1ms延时
  43          {
  44   1              uchar x,j;
  45   1              for(j=0;j<i;j++)
  46   1                      for(x=0;x<=148;x++);    
  47   1      }
  48          
  49          /********************************************************************
  50          * 名称 : Bell(int x)
  51          * 功能 : 发声
  52          * 输入 : int x （发声时间）
  53          * 输出 : 无
  54          ***********************************************************************/
  55          void Bell(int x)
C51 COMPILER V7.10   TEST                                                                  03/22/2013 20:18:22 PAGE 2   

  56          {
  57   1              for(;x>0;x--)
  58   1              {
  59   2                      BELL=0;
  60   2                      Delay(1);
  61   2                      BELL=1;
  62   2                      Delay(1);
  63   2              }
  64   1              
  65   1      }
  66          /********************************************************************
  67          * 名称 : Com_Int()
  68          * 功能 : 串口中断子函数
  69          * 输入 : 无
  70          * 输出 : 无
  71          ***********************************************************************/
  72          void Com_Int(void) interrupt 4
  73          {
  74   1              static uchar i = M-1;    //定义为静态变量，当重新进入这个子函数时 i 的值不会发生改变
  75   1              EA = 0;
  76   1              if(RI == 1)   //当硬件接收到一个数据时，RI会置位
  77   1              {
  78   2                      LED_Buffer[i] = SBUF - 48; //这里减去48是因为从电脑中发送过来的数据是ASCII码。
  79   2                      RI = 0;  
  80   2                      if(0==i) 
  81   2                              i=M;
  82   2                      i--;
  83   2              }
  84   1              EA = 1;
  85   1      }
  86          
  87          /********************************************************************
  88          * 名称 : Com_Init()
  89          * 功能 : 串口初始化，晶振11.0592,波特率9600，使能了串口中断
  90          * 输入 : 无
  91          * 输出 : 无
  92          ***********************************************************************/
  93          void Com_Init(void)
  94          {
  95   1           TMOD = 0x20;
  96   1           PCON = 0x00;
  97   1           SCON = 0x50;                       
  98   1           TH1 = 0xFd;    //设置波特率 9600
  99   1           TL1 = 0xFd;
 100   1           TR1 = 1;           //启动定时器1
 101   1               ES = 1;                //开串口中断
 102   1               EA = 1;                //开总中断              
 103   1      }
 104          
 105          /********************************************************************
 106          * 名称 : led_display(uint data)
 107          * 功能 : 显示一个数字
 108          * 输入 : int 四位 数字
 109          * 输出 : 无
 110          ***********************************************************************/
 111          void led_display(uchar *data1)
 112          {
 113   1                      Delay_1ms(1);
 114   1                      P0=table[data1[0]];
 115   1                      Led1=0;
 116   1                      Led2=1;
 117   1                      Led3=1;
C51 COMPILER V7.10   TEST                                                                  03/22/2013 20:18:22 PAGE 3   

 118   1                      Led4=1;
 119   1                      Delay_1ms(1);
 120   1                      P0=table[data1[1]];
 121   1                      Led1=1;
 122   1                      Led2=0;
 123   1                      Led3=1;
 124   1                      Led4=1;
 125   1                      Delay_1ms(1);
 126   1                      P0=table[data1[2]];
 127   1                      Led1=1;
 128   1                      Led2=1;
 129   1                      Led3=0;
 130   1                      Led4=1;
 131   1                      Delay_1ms(1);
 132   1                      P0=table[data1[3]];
 133   1                      Led1=1;
 134   1                      Led2=1;
 135   1                      Led3=1;
 136   1                      Led4=0;
 137   1      }
 138          /********************************************************************
 139          * 名称 : Main()
 140          * 功能 : 主函数
 141          * 输入 : 无
 142          * 输出 : 无
 143          ***********************************************************************/
 144          void Main()
 145          {
 146   1              uchar i = 0;
 147   1              Delay_1ms(100);
 148   1              Com_Init();
 149   1              ;  //这里把P3口的最高为置1，进入循环后 循环左移 一位正好是P3 最低为置1
 150   1              while(1)
 151   1              {
 152   2                      led_display(LED_Buffer);
 153   2                      Delay(15);
 154   2              }
 155   1      }                                                  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    270    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
