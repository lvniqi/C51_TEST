C51 COMPILER V9.00   DS1302Ê±_ÓÐ¾Æ¬ÊµÑé2                                                   04/24/2013 01:49:03 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DS1302Ê±_ÓÐ¾Æ¬ÊµÑé2
OBJECT MODULE PLACED IN DS1302Ê±ÖÓÐ¾Æ¬ÊµÑé2.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE DS1302Ê±ÖÓÐ¾Æ¬ÊµÑé2.C BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          
   3          /***************************************************************************
   4          ÊµÑéÊ®¾Å:   DS1302Ê±ÖÓÐ¾Æ¬ÊµÑé
   5          ËµÃ÷:       ÒòÎªÖ»ÓÐËÄÎ»ÊýÂë¹Ü
   6                      ÎªÁË·½±ã¿´µ½ÊµÑéÐ§ê½Ö»ÏÔÊ¾·ÖÓëÃë
   7          ÊµÑéÏÖÏó:   ÊýÂë¹ÜÉÏÏÔÊ¾·ÖÓëÃë 
   8          
   9          Á¬ÏßËµÃ÷:   1,½«ÊýÂë¹ÜµÄa-dot½Óµ½P0¿Ú             (Á¬½ÓÇë×¢ÒâË³Ðò)
  10                      2,½«ÊýÂë¹ÜµÄs1-s4½Óµ½P34-P37
  11                                  3,½«DS1302·Ö±ð½ÓÒÔÏÂÁ¬½Ó
  12                                    SCLK----------P22
  13                                    I/O ----------P21
  14                                    RST ----------P20
  15                    
  16          
  17          
  18          ****************************************************************************/
  19          /*********************************°üº¬Í·ÎÄ¼þ********************************/
  20          #include"normal.h"
  21          #include"led_4.h"
  22          #include"pt.h"
  23          /*********************************¶Ë¿Ú¶¨Òå**********************************/
  24          sbit DS1302_CLK = P1^4;
  25          sbit DS1302_IO = P3^2;
  26          sbit DS1302_RST = P3^3;
  27          PT pt;
  28          /******************************¶¨ÒåÈ«¾Ö±äÁ¿*********************************/
  29          uchar second,minute,hour,week,day,month,year;   
  30          const uchar time[]={0x00,0x00,0x00,0x00,0x01,0x47,0x59}; //³õÊ¼Ê±¼äÊý×é
  31          /*****************************************************************************
  32          º¯Êý¹¦ÄÜ:ÏòDS1302ËÍÒ»×Ö½ÚÊý¾Ý×Ó³ÌÐò
  33          Èë¿Ú²ÎÊý:
  34          ³ö¿Ú²ÎÊý:
  35          *****************************************************************************/
  36          void InputByte(uchar byte)
  37          {
  38   1           char i;
  39   1           for(i=8;i>0;i--)
  40   1           {
  41   2           DS1302_IO=(bit)(byte&0x01);
  42   2           DS1302_CLK=1;
  43   2           _nop_();
  44   2           DS1302_CLK=0;
  45   2           byte>>=1;
  46   2           }
  47   1           return;
  48   1      }
  49          
  50          /*****************************************************************************
  51          º¯Êý¹¦ÄÜ:¶ÁDS1302Ò»¸ö×Ö½Ú×Ó³ÌÐò
  52          Èë¿Ú²ÎÊý:
  53          ³ö¿Ú²ÎÊý:
  54          *****************************************************************************/
  55          uchar outputbyte(void) 
C51 COMPILER V9.00   DS1302Ê±_ÓÐ¾Æ¬ÊµÑé2                                                   04/24/2013 01:49:03 PAGE 2   

  56          {
  57   1            uchar i;
  58   1            uchar ucdat=0;
  59   1            for(i=8;i>0;i--)
  60   1            {
  61   2            DS1302_IO=1;
  62   2            ucdat>>=1;
  63   2            if(DS1302_IO)ucdat|=0x80;
  64   2            DS1302_CLK=1;
  65   2            _nop_();
  66   2            DS1302_CLK=0;
  67   2            }
  68   1            return(ucdat);
  69   1      }
  70          
  71          /*****************************************************************************
  72          º¯Êý¹¦ÄÜ:ÏòDS1302Ä³µØÖ·Ð´Ò»×Ö½ÚÊý¾Ý×Ó³ÌÐò
  73          Èë¿Ú²ÎÊý:addr,TDat
  74          ³ö¿Ú²ÎÊý:
  75          *****************************************************************************/
  76          void write_ds1302(uchar addr,uchar TDat)
  77          {
  78   1           DS1302_RST=0;
  79   1           _nop_();
  80   1           DS1302_CLK=0;
  81   1           _nop_();
  82   1           DS1302_RST=1;
  83   1           InputByte(addr);
  84   1           _nop_();
  85   1           InputByte(TDat);
  86   1           DS1302_CLK=1;
  87   1           _nop_();
  88   1           DS1302_RST=0;
  89   1      }
  90          
  91          /*****************************************************************************
  92          º¯Êý¹¦ÄÜ:¶ÁDS1302µØÖ·×Ó³ÌÐò
  93          Èë¿Ú²ÎÊý:add
  94          ³ö¿Ú²ÎÊý:timedata
  95          *****************************************************************************/
  96          uchar read_ds1302(uchar addr)
  97          {
  98   1            uchar timedata;
  99   1            DS1302_RST=0;
 100   1            _nop_();
 101   1            DS1302_CLK=0;
 102   1            _nop_();
 103   1            DS1302_RST=1;
 104   1            InputByte(addr);
 105   1            timedata=OutputByte();
*** WARNING C206 IN LINE 105 OF DS1302Ê±ÖÓÐ¾Æ¬ÊµÑé2.C: 'OutputByte': missing function-prototype
 106   1            DS1302_CLK=1;
 107   1            _nop_();
 108   1            DS1302_RST=0;
 109   1            return(timedata);
 110   1      }
 111          
 112          /*****************************************************************************
 113          º¯Êý¹¦ÄÜ:³õÊ¼»¯DS1302×Ó³ÌÐò
 114          Èë¿Ú²ÎÊý:time[](È«¾Ö±äÁ¿)
 115          ³ö¿Ú²ÎÊý:
 116          *****************************************************************************/
C51 COMPILER V9.00   DS1302Ê±_ÓÐ¾Æ¬ÊµÑé2                                                   04/24/2013 01:49:03 PAGE 3   

 117          void initial_ds1302()
 118          {
 119   1           write_ds1302(0x8e,0x00);      //Ð´±£»¤¼Ä´æÆ÷£¬ÔÚ¶ÔÊ±ÖÓ»òRAMÐ´Ç°WPÒ»¶¨ÒªÎª0
 120   1           write_ds1302(0x8c,time[0]);   //Äê
 121   1           write_ds1302(0x88,time[1]);   //ÔÂ
 122   1           write_ds1302(0x86,time[2]);   //ÈÕ
 123   1           write_ds1302(0x8A,time[3]);   //ÐÇÆÚ
 124   1           write_ds1302(0x84,time[4]);   //Ê±
 125   1           write_ds1302(0x82,time[5]);   //·Ö
 126   1           write_ds1302(0x80,time[6]);   //Ãë
 127   1           write_ds1302(0x8e,0x80);      //Ð´±£»¤¼Ä´æÆ÷
 128   1      }
 129          
 130          /*****************************************************************************
 131          º¯Êý¹¦ÄÜ:¶ÁDS1302Ê±¼ä×Ó³ÌÐò
 132          Èë¿Ú²ÎÊý:
 133          ³ö¿Ú²ÎÊý:È«¾Ö±äÁ¿(second,minute,hour,week,day,month,year)
 134          *****************************************************************************/
 135          static int  read_time(PT* pt)
 136          {
 137   1               uchar temp;
 138   1               PT_BEGIN(pt);
 139   3               while(1)
 140   3                      {
 141   4      //               PT_WAIT_UNTIL(pt,timer_0>=20);
 142   4      //               temp=read_ds1302(0x81);   //Ãë¼Ä´æÆ÷
 143   4      //               write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 144   4      //               second=(temp/16)*10+(temp&0x0f);
 145   4                       PT_WAIT_UNTIL(pt,timer_0>=1000);
 146   4                       temp=read_ds1302(0x83);   //·Ö
 147   4                       write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 148   4                       minute=(temp/16)*10+(temp&0x0f);
 149   4                       PT_WAIT_UNTIL(pt,timer_0>=2000);
 150   4                       temp=read_ds1302(0x85);     //Ê±
 151   4                       write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 152   4                       hour=(temp/16)*10+(temp&0x0f);
 153   4      //               PT_WAIT_UNTIL(pt,timer_0>=100);
 154   4      //               week=read_ds1302(0x8B);     //ÐÇÆÚ
 155   4      //               write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 156   4      //               PT_WAIT_UNTIL(pt,timer_0>=130);
 157   4      //               day=read_ds1302(0x87);      //ÈÕ
 158   4      //       write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 159   4      //               PT_WAIT_UNTIL(pt,timer_0>=140);
 160   4      //               month=read_ds1302(0x89);    //ÔÂ
 161   4      //       write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 162   4      //               PT_WAIT_UNTIL(pt,timer_0>=190);
 163   4      //               year=read_ds1302(0x8d);     //Äê
 164   4      //               write_ds1302(0x00,0x00);        //¼Ç×¡Å¶£¡£¡£¡£¡£¡£¡£¡£¡£¡
 165   4                       timer_0=0;
 166   4                       Led_set(hour*100+minute);
 167   4                      }
 168   3              PT_END(pt);
 169   1      }
 170          
 171          /*****************************************************************************
 172          º¯Êý¹¦ÄÜ:Ö÷³ÌÐò
 173          Èë¿Ú²ÎÊý:
 174          ³ö¿Ú²ÎÊý:
 175          *****************************************************************************/
 176          void main(void)
 177          {
 178   1      //      initial_ds1302();     //³õÊ¼»¯DS1302
C51 COMPILER V9.00   DS1302Ê±_ÓÐ¾Æ¬ÊµÑé2                                                   04/24/2013 01:49:03 PAGE 4   

 179   1              PT_INIT(&pt);
 180   1              set_timer_0();
 181   1              timer_0_start();
 182   1          while(1)
 183   1           {
 184   2               read_time(&pt);          //¶ÁÈ¡Ê±¼ä
 185   2               Led_display(LED_Buffer);            //ÏÔÊ¾Ê±¼ä
 186   2           }
 187   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    657    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
