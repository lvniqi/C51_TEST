A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     1


MACRO ASSEMBLER A51 V7.09
OBJECT MODULE PLACED IN IR-1602LCD.OBJ
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE IR-1602LCD.asm SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

                       1     
                       2     
                       3     
                       4     
                       5     
                       6     
                       7     
                       8     
                       9     ;-----------------------------------------------
  0020                10            IRCOM  EQU  20H       ;20H-23H IR使用
  0026                11             X     EQU  26H       ;LCD 地址变量
                      12     
  0091                13            IRIN   EQU  P1.1
  00B7                14            BEEP   EQU  P3.7      ;蜂鸣器
  00B6                15            RELAY  EQU  P3.6      ;继电器
                      16            
  00A2                17             RS    EQU  P2.2
  00A1                18             RW    EQU  P2.1
  00A0                19             EN    EQU  P2.0
                      20     ;------------------------------------------------
0000                  21              ORG 0000H
0000 8000             22              JMP  MAIN
                      23     ;------------------------------------------------
0002                  24     MAIN:
0002 758140           25               MOV   SP,#40H
0005 7400             26               MOV   A,#00H
0007 7820             27               MOV   R0,#20H
0009 F6               28     LOOP0:    MOV   @R0,A          ;20H-26H清零
000A 08               29               INC   R0
000B B827FB           30               CJNE  R0,#27H,LOOP0
000E D291             31               SETB  IRIN
0010 1126             32               CALL  SET_LCD
0012 1188             33               CALL  MENU1
0014                  34     LOOP1:
0014 11EF             35               CALL  IR_IN
0016 3135             36               CALL  IR_SHOW
0018 E522             37               MOV  A,22H
001A B41D02           38               CJNE  A,#1DH,LOOP2    ;UP键按下
001D C2B6             39               CLR   RELAY           ;继电器吸合
001F B41202           40     LOOP2:    CJNE  A,#12H,LOOP3    ;DOWN键按下
0022 D2B6             41               SETB  RELAY           ;继电器关闭
0024 80EE             42     LOOP3:    JMP   LOOP1
                      43               
                      44     ;-----------------------------------------------------
                      45     ;  LCD 初始化设置
                      46     ;-----------------------------------------------------
0026                  47     SET_LCD:
0026 C2A0             48               CLR  EN
0028 113B             49               CALL  INIT_LCD     ;初始化 LCD
002A 319E             50               CALL  DELAY1
002C 9000A1           51               MOV  DPTR,#INFO1   ;指针指到显示信息1
002F 7401             52               MOV  A,#1          ;显示在第一行
0031 115A             53               CALL  LCD_SHOW
0033 9000B2           54               MOV  DPTR,#INFO2   ;指针指到显示信息2
0036 7402             55               MOV  A,#2          ;显示在第二行
0038 115A             56               CALL  LCD_SHOW
003A 22               57               RET
                      58     ;-----------------------------------------------------
A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     2

003B                  59     INIT_LCD:                 ;8位I/O控制 LCD 接口初始化
003B 7438             60               MOV  A,#38H     ;双列显示，字形5*7点阵
003D 11C3             61               CALL  WCOM
003F 319E             62               CALL  DELAY1
0041 7438             63               MOV  A,#38H     ;双列显示，字形5*7点阵
0043 11C3             64               CALL  WCOM
0045 319E             65               CALL  DELAY1
0047 7438             66               MOV  A,#38H     ;双列显示，字形5*7点阵
0049 11C3             67               CALL  WCOM
004B 319E             68               CALL  DELAY1
004D 740C             69               MOV  A,#0CH     ;开显示，关光标，
004F 11C3             70               CALL  WCOM
0051 319E             71               CALL  DELAY1
0053 7401             72               MOV  A,#01H     ;清除 LCD 显示屏
0055 11C3             73               CALL  WCOM
0057 319E             74               CALL  DELAY1
0059 22               75               RET
                      76     ;----------------------------------------------------
005A                  77     LCD_SHOW:       ;在LCD的第一行或第二行显示信息字符
                      78     
005A B4010C           79               CJNE  A,#1,LINE2  ;判断是否为第一行
005D 7480             80       LINE1:  MOV  A,#80H       ;设置 LCD 的第一行地址
005F 11C3             81               CALL  WCOM        ;写入命令
0061 117F             82               CALL  CLR_LINE    ;清除该行字符数据
0063 7480             83               MOV  A,#80H       ;设置 LCD 的第一行地址
0065 11C3             84               CALL  WCOM        ;写入命令
0067 800A             85               JMP  FILL
                      86     
0069 74C0             87       LINE2:  MOV  A,#0C0H      ;设置 LCD 的第二行地址
006B 11C3             88               CALL  WCOM        ;写入命令
006D 117F             89               CALL  CLR_LINE    ;清除该行字符数据
006F 74C0             90               MOV  A,#0C0H      ;设置 LCD 的第二行地址
0071 11C3             91               CALL  WCOM
0073 E4               92       FILL:   CLR  A            ;填入字符
0074 93               93               MOVC  A,@A+DPTR   ;由消息区取出字符
0075 B40001           94               CJNE  A,#0,LC1    ;判断是否为结束码
0078 22               95               RET
0079 11D0             96       LC1:    CALL  WDATA       ;写入数据
007B A3               97               INC  DPTR         ;指针加1
007C 80F5             98               JMP  FILL         ;继续填入字符
007E 22               99               RET
                     100     ;---------------------------------------------------
007F                 101     CLR_LINE:                  ;清除该行 LCD 的字符
007F 7818            102               MOV  R0,#24
0081 7420            103        CL1:   MOV  A,#' '
0083 11D0            104               CALL  WDATA
0085 D8FA            105               DJNZ  R0,CL1
0087 22              106               RET
                     107     ;----------------------------------------------------
0088                 108     MENU1:                      ;LCD 显示工作菜单信息
0088 900090          109              MOV   DPTR,#MENU2
008B 7401            110              MOV   A,#1         ;在第一行显示信息
008D 115A            111              CALL  LCD_SHOW
008F 22              112              RET
0090 2052454D        113     MENU2:  DB  " REMOTE CONTROL ",0
0094 4F544520                
0098 434F4E54                
009C 524F4C20                
00A0 00                      
                     114     ;-----------------------------------------------------
00A1 20202020        115     INFO1:  DB  "                ",0  ;LCD 第一行显示信息
00A5 20202020                
00A9 20202020                
00AD 20202020                
00B1 00                      
00B2 20204952        116     INFO2:  DB  "  IR-CODE: --H  ",0  ;LCD 第二行显示信息
A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     3

00B6 2D434F44                
00BA 453A202D                
00BE 2D482020                
00C2 00                      
                     117     ;-----------------------------------------------------
                     118     
                     119     ;-----------------------------------------------------
                     120     ; 写指令、数据使能子程序
                     121     ;-----------------------------------------------------
00C3                 122     WCOM:
00C3 F580            123               MOV  P0,A        ;写指令使能
00C5 C2A2            124               CLR RS           ;RS=L,RW=L,D0-D7=指令码，E=高脉冲
00C7 C2A1            125               CLR RW
00C9 D2A0            126               SETB EN
00CB 11DD            127               CALL  DELAY0
00CD C2A0            128               CLR EN
00CF 22              129               RET
                     130                       
00D0                 131     WDATA:
00D0 F580            132               MOV   P0,A      ;写数据使能
00D2 D2A2            133               SETB  RS        ;RS=H,RW=L,D0-D7=数据，E=高脉冲
00D4 C2A1            134               CLR   RW
00D6 D2A0            135               SETB  EN
00D8 11DD            136               CALL  DELAY0
00DA C2A0            137               CLR   EN
00DC 22              138               RET
                     139     
00DD 7FFA            140     DELAY0:   MOV  R7,#250      ;延时500微秒
00DF DFFE            141               DJNZ  R7,$
00E1 22              142               RET
                     143     ;---------------------------------------------------
                     144     ;在 LCD 第二行显示字符
                     145     ;A=ASC DATA, B=LINE X POS
                     146     ;---------------------------------------------------
00E2                 147     LCDP2:                    ;在LCD的第二行显示字符
00E2 C0E0            148              PUSH  ACC        ;
00E4 E5F0            149              MOV  A,B         ;设置显示地址
00E6 24C0            150              ADD  A,#0C0H     ;设置LCD的第二行地址
00E8 11C3            151              CALL  WCOM       ;写入命令
00EA D0E0            152              POP  ACC         ;由堆栈取出A
00EC 11D0            153              CALL  WDATA      ;写入数据
00EE 22              154              RET
                     155     ;---------------------------------------------------
                     156     ; IR 译码子程序
                     157     ;---------------------------------------------------
00EF                 158     IR_IN:              
00EF 7820            159               MOV   R0,#IRCOM
00F1 309102          160      I1:      JNB  IRIN,I2       ;等待 IR 信号出现
00F4 80FB            161               JMP  I1
00F6 7C14            162      I2:      MOV  R4,#20
00F8 3191            163      I20:     CALL  DEL
00FA DCFC            164               DJNZ  R4,I20
00FC 2091F2          165               JB  IRIN,I1        ;确认IR信号出现
00FF 209104          166      I21:     JB  IRIN,I3        ;等 IR 变为高电平
0102 3191            167               CALL  DEL
0104 80F9            168               JMP  I21
0106 7B00            169      I3:      MOV  R3,#0         ;8位数清为0
0108 309104          170      LL:      JNB  IRIN,I4       ;等 IR 变为低电平
010B 3191            171               CALL  DEL
010D 80F9            172               JMP  LL
010F 209104          173      I4:      JB  IRIN,I5        ;等 IR 变为高电平
0112 3191            174               CALL  DEL
0114 80F9            175               JMP  I4
0116 7A00            176      I5:      MOV  R2,#0         ;0.14ms 计数
0118 3191            177      L1:      CALL  DEL
011A 209113          178               JB  IRIN, N1       ;等 IR 变为高电平
A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     4

                     179                                  ;IR=0，检查R2中的计数值 
011D 7408            180               MOV  A,#8
011F C3              181               CLR  C
0120 9A              182               SUBB  A,R2         ;判断高低位
                     183                                  ;IF C=0  BIT=0
0121 E6              184               MOV  A,@R0
0122 13              185               RRC  A
0123 F6              186               MOV  @R0,A         ;处理完一位
0124 0B              187               INC  R3
0125 BB08E0          188               CJNE  R3,#8,LL     ;需处理完8位  
0128 7B00            189               MOV  R3,#0
012A 08              190               INC  R0
012B B824DA          191               CJNE  R0,#24H,LL   ;收集到4字节了
012E 8004            192               JMP  OK
0130 0A              193      N1:      INC  R2
0131 BA1EE4          194               CJNE  R2,#30,L1    ;0.14ms 计数过长则时间到自动离开
0134 22              195      OK:      RET
                     196     ;--------------------------------------------------------------------
0135                 197     IR_SHOW:
0135 E522            198               MOV A,22H
0137 F4              199               CPL A                ;将22H取反后和23H比较
0138 B52304          200               CJNE A,23H,IR_SHOW1  ;如果不等表示接收数据发生错误,放弃。
013B 3140            201               CALL   CONV
013D 3173            202               CALL  BEEP_BL        ;蜂鸣器鸣响表示解码成功
013F 22              203     IR_SHOW1: RET
                     204     ;--------------------------------------------------------------------
                     205     ;转换为 ASCII 码并显示
                     206     ;--------------------------------------------------------------------
0140                 207     CONV:
0140 75260B          208               MOV   X,#11        ;设置显示起始位置
0143 E522            209               MOV   A,22H
0145 54F0            210               ANL   A,#0F0H      ;取出高四位二进制数
0147 C4              211               SWAP  A            ;高四位与低四位互换
0148 C0E0            212               PUSH  ACC          ;压入堆栈
014A C3              213               CLR   C            ;C=0
014B 940A            214               SUBB  A,#0AH       ;减10
014D D0E0            215               POP   ACC          ;弹出堆栈
014F 4002            216               JC    ASCII0       ;该数小于10，转ASCII0
0151 2407            217               ADD   A,#07H       ;大于10的数加上37H
0153 2430            218     ASCII0:   ADD   A,#30H       ;小于10的数加上30H
0155 8526F0          219               MOV   B,X
0158 11E2            220               CALL  LCDP2
                     221     
015A E522            222               MOV   A,22H
015C 540F            223               ANL   A,#0FH        ;取出低四位二进制数
015E C0E0            224               PUSH  ACC
0160 C3              225               CLR   C
0161 940A            226               SUBB  A,#0AH        ;减10
0163 D0E0            227               POP   ACC
0165 4002            228               JC    ASCII1        ;该数小于10，转ASCII0
0167 2407            229               ADD   A,#07H        ;大于10的数加上37H
0169 2430            230     ASCII1:   ADD   A,#30H        ;小于10的数加上30H
016B 0526            231               INC   X
016D 8526F0          232               MOV   B,X
0170 11E2            233               CALL  LCDP2
0172 22              234               RET
                     235     ;--------------------------------------------------------
                     236     ;蜂鸣器响一声子程序
                     237     ;--------------------------------------------------------
0173                 238     BEEP_BL:
0173 7E64            239              MOV  R6,#100
0175 3180            240       BL1:   CALL  DEX1
0177 B2B7            241              CPL  BEEP
0179 DEFA            242              DJNZ  R6,BL1
017B 7D19            243              MOV  R5,#25
017D 3186            244              CALL  DELAY
A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     5

017F 22              245              RET
0180 7FB4            246      DEX1:   MOV  R7,#180
0182 00              247      DEX2:   NOP
0183 DFFD            248              DJNZ  R7,DEX2
0185 22              249              RET
0186                 250      DELAY:                    ;延时R5×10MS
0186 7E32            251              MOV  R6,#50
0188 7F64            252       D1:    MOV  R7,#100
018A DFFE            253              DJNZ  R7,$
018C DEFA            254              DJNZ  R6,D1
018E DDF6            255              DJNZ  R5,DELAY
0190 22              256              RET
                     257     ;------------------------------------------------
                     258     ; DELAY  R5*0.14MS
0191                 259     DEL:
0191 7D01            260               MOV  R5,#1       ;IR解码使用
0193 7E02            261     DEL0:     MOV  R6,#2
0195 7F20            262     DEL1:     MOV  R7,#32
0197 DFFE            263     DEL2:     DJNZ  R7,DEL2
0199 DEFA            264               DJNZ  R6,DEL1
019B DDF6            265               DJNZ  R5,DEL0
019D 22              266               RET
                     267     
019E                 268     DELAY1:                    ;延时5MS
019E 7E19            269              MOV  R6,#25
01A0 7F64            270       DL2:   MOV  R7,#100
01A2 DFFE            271              DJNZ  R7,$
01A4 DEFA            272              DJNZ  R6,DL2
01A6 22              273              RET
                     274     ;-------------------------------------------------
                     275             END
A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
ASCII0 . . . . . .  C ADDR   0153H   A   
ASCII1 . . . . . .  C ADDR   0169H   A   
B. . . . . . . . .  D ADDR   00F0H   A   
BEEP . . . . . . .  B ADDR   00B0H.7 A   
BEEP_BL. . . . . .  C ADDR   0173H   A   
BL1. . . . . . . .  C ADDR   0175H   A   
CL1. . . . . . . .  C ADDR   0081H   A   
CLR_LINE . . . . .  C ADDR   007FH   A   
CONV . . . . . . .  C ADDR   0140H   A   
D1 . . . . . . . .  C ADDR   0188H   A   
DEL. . . . . . . .  C ADDR   0191H   A   
DEL0 . . . . . . .  C ADDR   0193H   A   
DEL1 . . . . . . .  C ADDR   0195H   A   
DEL2 . . . . . . .  C ADDR   0197H   A   
DELAY. . . . . . .  C ADDR   0186H   A   
DELAY0 . . . . . .  C ADDR   00DDH   A   
DELAY1 . . . . . .  C ADDR   019EH   A   
DEX1 . . . . . . .  C ADDR   0180H   A   
DEX2 . . . . . . .  C ADDR   0182H   A   
DL2. . . . . . . .  C ADDR   01A0H   A   
EN . . . . . . . .  B ADDR   00A0H.0 A   
FILL . . . . . . .  C ADDR   0073H   A   
I1 . . . . . . . .  C ADDR   00F1H   A   
I2 . . . . . . . .  C ADDR   00F6H   A   
I20. . . . . . . .  C ADDR   00F8H   A   
I21. . . . . . . .  C ADDR   00FFH   A   
I3 . . . . . . . .  C ADDR   0106H   A   
I4 . . . . . . . .  C ADDR   010FH   A   
I5 . . . . . . . .  C ADDR   0116H   A   
INFO1. . . . . . .  C ADDR   00A1H   A   
INFO2. . . . . . .  C ADDR   00B2H   A   
INIT_LCD . . . . .  C ADDR   003BH   A   
IRCOM. . . . . . .  N NUMB   0020H   A   
IRIN . . . . . . .  B ADDR   0090H.1 A   
IR_IN. . . . . . .  C ADDR   00EFH   A   
IR_SHOW. . . . . .  C ADDR   0135H   A   
IR_SHOW1 . . . . .  C ADDR   013FH   A   
L1 . . . . . . . .  C ADDR   0118H   A   
LC1. . . . . . . .  C ADDR   0079H   A   
LCDP2. . . . . . .  C ADDR   00E2H   A   
LCD_SHOW . . . . .  C ADDR   005AH   A   
LINE1. . . . . . .  C ADDR   005DH   A   
LINE2. . . . . . .  C ADDR   0069H   A   
LL . . . . . . . .  C ADDR   0108H   A   
LOOP0. . . . . . .  C ADDR   0009H   A   
LOOP1. . . . . . .  C ADDR   0014H   A   
LOOP2. . . . . . .  C ADDR   001FH   A   
LOOP3. . . . . . .  C ADDR   0024H   A   
MAIN . . . . . . .  C ADDR   0002H   A   
MENU1. . . . . . .  C ADDR   0088H   A   
MENU2. . . . . . .  C ADDR   0090H   A   
N1 . . . . . . . .  C ADDR   0130H   A   
OK . . . . . . . .  C ADDR   0134H   A   
P0 . . . . . . . .  D ADDR   0080H   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
P3 . . . . . . . .  D ADDR   00B0H   A   
RELAY. . . . . . .  B ADDR   00B0H.6 A   
RS . . . . . . . .  B ADDR   00A0H.2 A   
A51 MACRO ASSEMBLER  IR_1602LCD                                                           06/05/2012 07:20:32 PAGE     7

RW . . . . . . . .  B ADDR   00A0H.1 A   
SET_LCD. . . . . .  C ADDR   0026H   A   
SP . . . . . . . .  D ADDR   0081H   A   
WCOM . . . . . . .  C ADDR   00C3H   A   
WDATA. . . . . . .  C ADDR   00D0H   A   
X. . . . . . . . .  N NUMB   0026H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
