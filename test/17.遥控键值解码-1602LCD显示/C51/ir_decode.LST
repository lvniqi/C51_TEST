C51 COMPILER V9.00   IR_DECODE                                                             04/25/2013 17:12:54 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE IR_DECODE
OBJECT MODULE PLACED IN ir_decode.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ir_decode.C BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /******************************************************************
   2          /*                                                                *
   3          /* 单片机开发系统演示程序                                 *
   4          /*                                                                *
   5          /*   启程电子                              *
   6          /*                                                                *
   7          /******************************************************************/
   8          
   9          #include <reg52.h>
  10          #include <intrins.h>
  11          
  12          #define uchar unsigned char
  13          #define uint  unsigned int
  14          #define delayNOP(); {_nop_();_nop_();_nop_();_nop_();};
  15          
  16          void delay(uchar x);  //x*0.14MS
  17          void delay1(int ms);
  18          void beep();
  19          
  20          sbit IRIN = P1^0;         //红外接收器数据线
  21          sbit BEEP = P3^7;         //蜂鸣器驱动线
  22          sbit RELAY= P3^6;         //继电器驱动线
  23          
  24          uchar IRCOM[7];
  25          
  26          sbit LCD_RS = P2^2;             
  27          sbit LCD_RW = P2^1;
  28          sbit LCD_EN = P2^0;
  29          
  30          uchar code  cdis1[ ] = {" REMOTE CONTROL "};
  31          uchar code  cdis2[ ] = {"  IR-CODE: --H  "};
  32          
  33          /*******************************************************************/
  34          /*                                                                 */
  35          /*检查LCD忙状态                                                    */
  36          /*lcd_busy为1时，忙，等待。lcd-busy为0时,闲，可写指令与数据。      */
  37          /*                                                                 */
  38          /*******************************************************************/ 
  39          
  40          bit lcd_busy()
  41           {                          
  42   1          bit result;
  43   1          LCD_RS = 0;
  44   1          LCD_RW = 1;
  45   1          LCD_EN = 1;
  46   1          delayNOP();
  47   1          result = (bit)(P0&0x80);
  48   1          LCD_EN = 0;
  49   1          return(result); 
  50   1       }
  51          
  52          /*******************************************************************/
  53          /*                                                                 */
  54          /*写指令数据到LCD                                                  */
  55          /*RS=L，RW=L，E=高脉冲，D0-D7=指令码。                             */
C51 COMPILER V9.00   IR_DECODE                                                             04/25/2013 17:12:54 PAGE 2   

  56          /*                                                                 */
  57          /*******************************************************************/
  58          
  59          void lcd_wcmd(uchar cmd)
  60          
  61          {                          
  62   1         while(lcd_busy());
  63   1          LCD_RS = 0;
  64   1          LCD_RW = 0;
  65   1          LCD_EN = 0;
  66   1          _nop_();
  67   1          _nop_(); 
  68   1          P0 = cmd;
  69   1          delayNOP();
  70   1          LCD_EN = 1;
  71   1          delayNOP();
  72   1          LCD_EN = 0;  
  73   1      }
  74          
  75          /*******************************************************************/
  76          /*                                                                 */
  77          /*写显示数据到LCD                                                  */
  78          /*RS=H，RW=L，E=高脉冲，D0-D7=数据。                               */
  79          /*                                                                 */
  80          /*******************************************************************/
  81          
  82          void lcd_wdat(uchar dat)
  83          {                          
  84   1         while(lcd_busy());
  85   1          LCD_RS = 1;
  86   1          LCD_RW = 0;
  87   1          LCD_EN = 0;
  88   1          P0 = dat;
  89   1          delayNOP();
  90   1          LCD_EN = 1;
  91   1          delayNOP();
  92   1          LCD_EN = 0; 
  93   1      }
  94          
  95          /*******************************************************************/
  96          /*                                                                 */
  97          /*  LCD初始化设定                                                  */
  98          /*                                                                 */
  99          /*******************************************************************/
 100          
 101          void lcd_init()
 102          { 
 103   1          delay1(15);                   
 104   1          lcd_wcmd(0x38);      //16*2显示，5*7点阵，8位数据
 105   1          delay1(5);
 106   1          lcd_wcmd(0x38);         
 107   1          delay1(5);
 108   1          lcd_wcmd(0x38);         
 109   1          delay1(5);
 110   1      
 111   1          lcd_wcmd(0x0c);      //显示开，关光标
 112   1          delay1(5);
 113   1          lcd_wcmd(0x06);      //移动光标
 114   1          delay1(5);
 115   1          lcd_wcmd(0x01);      //清除LCD的显示内容
 116   1          delay1(5);
 117   1      }
C51 COMPILER V9.00   IR_DECODE                                                             04/25/2013 17:12:54 PAGE 3   

 118          
 119          /*******************************************************************/
 120          /*                                                                 */
 121          /*  设定显示位置                                                   */
 122          /*                                                                 */
 123          /*******************************************************************/
 124          
 125          void lcd_pos(uchar pos)
 126          {                          
 127   1        lcd_wcmd(pos | 0x80);  //数据指针=80+地址变量
 128   1      }
 129          
 130          /*******************************************************************/
 131          main()
 132          {
 133   1         uchar m;
 134   1        
 135   1          IE = 0x81;                 //允许总中断中断,使能 INT0 外部中断
 136   1          TCON = 0x01;               //触发方式为脉冲负边沿触发
 137   1          
 138   1          IRIN=1;                    //I/O口初始化
 139   1          BEEP=1;
 140   1          RELAY=1; 
 141   1              
 142   1          delay1(10);                 //延时
 143   1          lcd_init();                //初始化LCD             
 144   1              
 145   1          lcd_pos(0);                //设置显示位置为第一行的第1个字符
 146   1          for(m=0;m<16;m++)
 147   1          lcd_wdat(cdis1[m]);
 148   1      
 149   1          lcd_pos(0x40);             //设置显示位置为第二行第1个字符
 150   1          for(m=0;m<16;m++)
 151   1          lcd_wdat(cdis2[m]);
 152   1      
 153   1         while(1)     
 154   1         {
 155   2            if(IRCOM[2]==0x1d)       //UP键
 156   2             RELAY=0;
 157   2            if(IRCOM[2]==0x12)       //DOWN键
 158   2             RELAY=1;
 159   2         }
 160   1      
 161   1      } //end main
 162          /**********************************************************/
 163          void IR_IN() interrupt 0 //using 0
 164          {
 165   1        unsigned char j,k,N=0;
 166   1           EX0 = 0;   
 167   1               delay(15);
 168   1               if (IRIN==1) 
 169   1           { EX0 =1;
 170   2                 return;
 171   2                } 
 172   1                                 //确认IR信号出现
 173   1        while (!IRIN)            //等IR变为高电平，跳过9ms的前导低电平信号。
 174   1          {delay(1);}
 175   1      
 176   1       for (j=0;j<4;j++)         //收集四组数据
 177   1       { 
 178   2        for (k=0;k<8;k++)        //每组数据有8位
 179   2        {
C51 COMPILER V9.00   IR_DECODE                                                             04/25/2013 17:12:54 PAGE 4   

 180   3         while (IRIN)            //等 IR 变为低电平，跳过4.5ms的前导高电平信号。
 181   3           {delay(1);}
 182   3          while (!IRIN)          //等 IR 变为高电平
 183   3           {delay(1);}
 184   3           while (IRIN)           //计算IR高电平时长
 185   3            {
 186   4          delay(1);
 187   4          N++;           
 188   4          if (N>=30)
 189   4               { EX0=1;
 190   5               return;}                  //0.14ms计数过长自动离开。
 191   4            }                        //高电平计数完毕                
 192   3           IRCOM[j]=IRCOM[j] >> 1;                  //数据最高位补“0”
 193   3           if (N>=8) {IRCOM[j] = IRCOM[j] | 0x80;}  //数据最高位补“1”
 194   3           N=0;
 195   3        }//end for k
 196   2       }//end for j
 197   1         
 198   1         if (IRCOM[2]!=~IRCOM[3])
 199   1         { EX0=1;
 200   2           return; }
 201   1      
 202   1         IRCOM[5]=IRCOM[2] & 0x0F;     //取键码的低四位
 203   1         IRCOM[6]=IRCOM[2] >> 4;       //右移4次，高四位变为低四位
 204   1      
 205   1         if(IRCOM[5]>9)
 206   1          { IRCOM[5]=IRCOM[5]+0x37;}
 207   1         else
 208   1                IRCOM[5]=IRCOM[5]+0x30;
 209   1      
 210   1         if(IRCOM[6]>9)
 211   1          { IRCOM[6]=IRCOM[6]+0x37;}
 212   1         else
 213   1                IRCOM[6]=IRCOM[6]+0x30;
 214   1      
 215   1           lcd_pos(0x4b);             
 216   1           lcd_wdat(IRCOM[6]);        //第一位数显示 
 217   1           lcd_pos(0x4c);             
 218   1           lcd_wdat(IRCOM[5]);        //第二位数显示
 219   1      
 220   1           beep();
 221   1           EX0 = 1; 
 222   1      } 
 223          
 224          /**********************************************************/
 225          void beep()
 226          {
 227   1        unsigned char i;
 228   1        for (i=0;i<180;i++)
 229   1         {
 230   2           delay(5);
 231   2           BEEP=!BEEP;                 //BEEP取反
 232   2         } 
 233   1        BEEP=1;                      //关闭蜂鸣器
 234   1      }
 235          /**********************************************************/
 236          void delay(unsigned char x)    //x*0.14MS
 237          {
 238   1       unsigned char i;
 239   1        while(x--)
 240   1       {
 241   2        for (i = 0; i<13; i++) {}
C51 COMPILER V9.00   IR_DECODE                                                             04/25/2013 17:12:54 PAGE 5   

 242   2       }
 243   1      }
 244          
 245          /**********************************************************/
 246          void delay1(int ms)
 247          {
 248   1       unsigned char y;
 249   1        while(ms--)
 250   1       {
 251   2        for(y = 0; y<250; y++)
 252   2        {
 253   3         _nop_();
 254   3         _nop_();
 255   3         _nop_();
 256   3         _nop_();
 257   3        }
 258   2       }
 259   1      }
 260          
 261          /*************************end******************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    556    ----
   CONSTANT SIZE    =     34    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
